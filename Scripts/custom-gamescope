#!/usr/bin/env bash
set -euo pipefail

# default mode: plain
USE_SCOPE=0
case "${1:-}" in
  --scope)
    USE_SCOPE=1
    shift
    ;;
esac

# defaults
USE_VRR=0
USE_EXPOSE_WL=0
FULLSCREEN=1
FORCE_GRAB=1
USE_GAMEMODE=0
HUD_MODE="no_display"
FPS_CAP=""
DRY_RUN=0
W="" ; H=""
SCALE_MODE=""   # new: -S option pass-through
SHARPNESS=""     # new: --sharpness option
USE_VKBASALT=0   # new: --vkbasalt option
FSR_SHARPNESS="" # new: --fsr option
FIXED_RES=1
AGGRESSIVE_MEM=0 # new: --aggressive-memory option

GAME_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --720p) W=1280; H=720 ;;
    --900p) W=1600; H=900 ;;
    --1080p) W=1920; H=1080 ;;
    --1440p) W=2560; H=1440 ;;
    --res=*) r="${1#--res=}"; W="${r%x*}"; H="${r#*x}" ;;
    --hud) HUD_MODE="default" ;;
    --hud=*) HUD_MODE="${1#--hud=}" ;;
    --no-hud) HUD_MODE="no_display" ;;
    --vrr) USE_VRR=1 ;;
    --no-vrr) USE_VRR=0 ;;
    --expose-wayland) USE_EXPOSE_WL=1 ;;
    --no-expose-wayland) USE_EXPOSE_WL=0 ;;
    --windowed) FULLSCREEN=0 ;;
    --no-grab) FORCE_GRAB=0 ;;
    --fps=*) FPS_CAP="${1#--fps=}" ;;
    --gamemode) USE_GAMEMODE=1 ;;
    --no-gamemode) USE_GAMEMODE=0 ;;
    -S) SCALE_MODE="$2"; shift ;;  # pass-through
    --sharpness) SHARPNESS="$2"; shift ;;
    --vkbasalt) USE_VKBASALT=1 ;;
    --fsr) FSR_SHARPNESS="$2"; shift ;;
    --no-fixed-res) FIXED_RES=0 ;;
    --aggressive-memory) AGGRESSIVE_MEM=1 ;;
    --dry) DRY_RUN=1 ;;
    --)
      shift
      GAME_ARGS+=("$@")
      break
      ;;
    *) GAME_ARGS+=("$1") ;;
  esac
  shift || true
done

if [[ ${#GAME_ARGS[@]} -eq 0 ]]; then
  echo "Usage: $0 [--scope] [opts] -- <cmd>" >&2
  exit 1
fi

# resolution auto-detect
if [[ -z "$W" || -z "$H" ]]; then
  if out="$(niri msg focused-output 2>/dev/null | grep 'Current mode:' || true)"; then
    read -r W H <<<"$(sed -E 's/.* ([0-9]+)x([0-9]+).*/\1 \2/' <<<"$out")"
  fi
fi
[[ -n "$W" ]] || W=1920
[[ -n "$H" ]] || H=1080

# environment
export mesa_glthread=true
export RADV_PERFTEST=gpl
export IS_GAME=1

# swap optimization - lock game memory in RAM
if [[ "$USE_GAMEMODE" -eq 1 ]] && command -v mlock >/dev/null 2>&1; then
  export LD_PRELOAD="${LD_PRELOAD:+$LD_PRELOAD:}libmlock.so"
fi

# vkbasalt config
if [[ "$USE_VKBASALT" -eq 1 ]]; then
  export ENABLE_VKBASALT=1
  export VKBASALT_CONFIG_FILE="$HOME/.config/vkBasalt/vkBasalt.conf"
else
  export ENABLE_VKBASALT=0
fi

if [[ "$HUD_MODE" != "no_display" ]]; then
  export MANGOHUD=1
else
  unset MANGOHUD || true
fi

# dry-run output
if [[ "$DRY_RUN" -eq 1 ]]; then
  if [[ "$USE_SCOPE" -eq 1 ]]; then
    printf 'DRY (scope) would run: '
    # Show gamemoderun if enabled
    [[ "$USE_GAMEMODE" -eq 1 ]] && printf 'gamemoderun '
    # Show aggressive memory if enabled
    if [[ "$USE_GAMEMODE" -eq 1 && "$AGGRESSIVE_MEM" -eq 1 ]]; then
      printf 'sudo cgexec -g memory:games-premium '
    elif [[ "$USE_GAMEMODE" -eq 1 ]]; then
      printf 'sudo cgexec -g memory:games-premium '
    fi
    printf 'gamescope '
    if [[ "$FIXED_RES" -eq 1 ]]; then
      printf -- "-W %s -H %s -w %s -h %s " "$W" "$H" "$W" "$H"
    else
      printf -- "-w %s -h %s " "$W" "$H"
    fi
    [[ $FULLSCREEN -eq 1 ]] && printf -- "-f "
    [[ $USE_VRR -eq 1 ]] && printf -- "--adaptive-sync "
    [[ $USE_EXPOSE_WL -eq 1 ]] && printf -- "--expose-wayland "
    [[ $FORCE_GRAB -eq 1 ]] && printf -- "--force-grab-cursor --cursor=disabled "
    [[ -n "$SCALE_MODE" ]] && printf -- "-S %s " "$SCALE_MODE"
    [[ -n "$SHARPNESS" ]] && printf -- "--sharpness %s " "$SHARPNESS"
    [[ -n "$FSR_SHARPNESS" ]] && printf -- "--fsr-sharpness %s " "$FSR_SHARPNESS"
    [[ -n "$FPS_CAP" ]] && printf -- "--fps %s " "$FPS_CAP"
    printf -- "-- "
    printf '%q ' "${GAME_ARGS[@]}"
    echo
  else
    printf 'DRY (plain) would run: '
    # Show gamemoderun if enabled
    [[ "$USE_GAMEMODE" -eq 1 ]] && printf 'gamemoderun '
    printf '%q ' "${GAME_ARGS[@]}"
    echo
  fi
  exit 0
fi

# launch plain mode
if [[ "$USE_SCOPE" -eq 0 ]]; then
  # For plain mode, just run the game directly
  exec "${GAME_ARGS[@]}"
fi

# build gamescope command
CMD=()

# Use gamemoderun for CPU/GPU optimization
if [[ "$USE_GAMEMODE" -eq 1 ]]; then
  CMD+=(gamemoderun)
fi

if [[ "$FIXED_RES" -eq 1 ]]; then
  CMD+=(gamescope -W "$W" -H "$H" -w "$W" -h "$H")
else
  CMD+=(gamescope -w "$W" -h "$H")
fi

[[ "$FULLSCREEN" -eq 1 ]] && CMD+=(-f)
[[ "$USE_VRR" -eq 1 ]] && CMD+=(--adaptive-sync)
[[ "$USE_EXPOSE_WL" -eq 1 ]] && CMD+=(--expose-wayland)
[[ "$FORCE_GRAB" -eq 1 ]] && CMD+=(--force-grab-cursor --cursor=disabled)
[[ -n "$SCALE_MODE" ]] && CMD+=(-S "$SCALE_MODE")
[[ -n "$SHARPNESS" ]] && CMD+=(--sharpness "$SHARPNESS")
[[ -n "$FSR_SHARPNESS" ]] && CMD+=(--fsr-sharpness "$FSR_SHARPNESS")
[[ -n "$FPS_CAP" ]] && CMD+=(--fps "$FPS_CAP")
CMD+=(-- "${GAME_ARGS[@]}")



# Run gamescope
"${CMD[@]}" &
GAMESCOPE_PID=$!

# Set up aggressive memory mode AFTER starting gamescope
if [[ "$USE_GAMEMODE" -eq 1 && "$AGGRESSIVE_MEM" -eq 1 ]]; then
  # Save original swappiness
  ORIGINAL_SWAPPINESS=$(cat /proc/sys/vm/swappiness 2>/dev/null || echo 60)
  
  notify-send "Game Protection" "Aggressive memory mode activated" -u normal
  echo "ðŸš€ Aggressive memory mode: optimizing memory for gaming..."
  
  # Extract game name dynamically from the command we're running
  GAME_BASENAME=$(basename "${GAME_ARGS[0]}" | sed 's/\.[^.]*$//')
  echo "ðŸŽ® Detected game: $GAME_BASENAME"
  
  # Single pkexec call to set everything up and get sudo access
  pkexec bash -c '
    # Set high swappiness to force other apps to swap and make room
    sysctl vm.swappiness=80 2>/dev/null || true
    
    # Protect the game we are running FIRST
    for pid in $(pgrep -u '$USER' -f "'$GAME_BASENAME'" 2>/dev/null); do
      echo -1000 | tee "/proc/$pid/oom_score_adj" 2>/dev/null && echo "ðŸ›¡ï¸ Protected game PID $pid"
    done
    
    # Also protect gamescope
    for pid in $(pgrep -u '$USER' "gamescope" 2>/dev/null); do
      echo -1000 | tee "/proc/$pid/oom_score_adj" 2>/dev/null && echo "ðŸ›¡ï¸ Protected gamescope PID $pid"
    done
    
    # Penalize memory-heavy apps to free up 1-2GB overhead
    for app in firefox discord chrome steam spotify; do
      for pid in $(pgrep -u '$USER' "$app" 2>/dev/null | head -3); do
        echo 500 | tee "/proc/$pid/oom_score_adj" 2>/dev/null || true
        echo "âš ï¸ Penalized $app PID $pid to free memory"
      done
    done
  '
  
  # Refresh sudo credentials for the rest of the session
  sudo -v
  
  # Protect this script and all children (including the game)
  echo $$ | sudo tee /proc/self/oom_score_adj >/dev/null
  echo "ðŸ›¡ï¸ Protected script PID $$ and all children"
  
  # Wait a moment for game to start
  sleep 3
  
  # Protect the game processes directly and keep checking for new ones
  echo "ðŸ” Monitoring for new game processes..."
  while true; do
    protected_any=0
    
    # Get all game processes
    for pid in $(pgrep -u $USER -f "$GAME_BASENAME" 2>/dev/null); do
      current_score=$(cat "/proc/$pid/oom_score_adj" 2>/dev/null || echo 0)
      if [[ "$current_score" != "-1000" ]]; then
        echo -1000 | sudo tee "/proc/$pid/oom_score_adj" 2>/dev/null && echo "ðŸ›¡ï¸ Protected game PID $pid (was $current_score)"
        protected_any=1
      fi
    done
    
    # If no new processes found in the last check, break
    if [[ "$protected_any" -eq 0 ]]; then
      echo "âœ… No new game processes found, monitoring complete"
      break
    fi
    
    sleep 10
  done
  
  # Also protect gamescope
  for pid in $(pgrep -u $USER "gamescope" 2>/dev/null); do
    echo -1000 | sudo tee "/proc/$pid/oom_score_adj" 2>/dev/null && echo "ðŸ›¡ï¸ Protected gamescope PID $pid"
  done
  
  # Cleanup function to restore original settings
  cleanup() {
    notify-send "Game Protection" "Restoring memory settings" -u normal
    echo "ðŸ”„ Restoring original swappiness ($ORIGINAL_SWAPPINESS)..."
    
    # Use sudo (should still have auth) to restore settings
    echo "$ORIGINAL_SWAPPINESS" | sudo tee /proc/sys/vm/swappiness 2>/dev/null || true
    
    # Reset OOM scores for all processes to default
    for pid in $(pgrep -u $USER 2>/dev/null); do
      if [[ -f "/proc/$pid/oom_score_adj" ]]; then
        echo 0 | sudo tee "/proc/$pid/oom_score_adj" 2>/dev/null || true
      fi
    done
  }
  
  # Set up cleanup on game exit
  trap "cleanup" EXIT INT TERM
fi

wait $GAMESCOPE_PID

# Cleanup after game exits
if [[ "$USE_GAMEMODE" -eq 1 && "$AGGRESSIVE_MEM" -eq 1 ]]; then
  notify-send "Game Protection" "Restoring memory settings" -u normal
  echo "ðŸ”„ Restoring original swappiness ($ORIGINAL_SWAPPINESS)..."
  
  # Use pkexec to restore settings (ensure we have permissions)
  pkexec bash -c "
    echo '$ORIGINAL_SWAPPINESS' | tee /proc/sys/vm/swappiness 2>/dev/null || true
    echo 'Swappiness restored to $ORIGINAL_SWAPPINESS'
    
    # Reset OOM scores for all processes to default
    for pid in \$(pgrep -u $USER 2>/dev/null); do
      if [[ -f '/proc/\$pid/oom_score_adj' ]]; then
        echo 0 | tee '/proc/\$pid/oom_score_adj' 2>/dev/null || true
      fi
    done
    echo 'OOM scores reset to default'
  "
fi
